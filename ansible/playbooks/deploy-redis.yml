- name: Deploy Redis HA
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'HELM_CHARTS_PATH') != ''
          - lookup('env', 'REDIS_PASSWORD') != ''
        fail_msg: "KUBECONFIG, HELM_CHARTS_PATH, and REDIS_PASSWORD environment variables must be set"

  tasks:
    - name: Create Redis namespace
      kubernetes.core.k8s:
        kind: Namespace
        name: redis
        state: present

    - name: Create Redis secrets
      kubernetes.core.k8s:
        apply: true
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: redis-secrets
            namespace: redis
          type: Opaque
          stringData:
            redis-password: "{{ lookup('env', 'REDIS_PASSWORD') }}"
      no_log: true

    - name: Deploy Redis HA
      kubernetes.core.helm:
        name: redis
        chart_ref: oci://registry-1.docker.io/bitnamicharts/redis
        chart_version: "24.1.0"
        release_namespace: redis
        create_namespace: false
        wait: true
        timeout: 5m
        values_files:
          - "{{ lookup('env', 'HELM_CHARTS_PATH') }}/redis/values.yml"
        set_values:
          - value: auth.existingSecret=redis-secrets
            value_type: string
          - value: auth.existingSecretPasswordKey=redis-password
            value_type: string
