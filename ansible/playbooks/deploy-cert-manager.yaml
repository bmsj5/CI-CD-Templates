- name: Deploy cert-manager
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'LETS_ENCRYPT_EMAIL') != ''
        fail_msg: "KUBECONFIG and LETS_ENCRYPT_EMAIL environment variables must be set"

  tasks:
    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: cert-manager
        chart_repo_url: https://charts.jetstack.io
        chart_version: v1.19.2
        release_namespace: cert-manager
        create_namespace: true
        wait: true
        timeout: "5m"
        set_values:
          - value: crds.enabled=true
            value_type: raw

    - name: Create Let's Encrypt ClusterIssuer
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: "{{ lookup('env', 'LETS_ENCRYPT_EMAIL') }}"
              privateKeySecretRef:
                name: letsencrypt-prod-key
              solvers:
                - http01:
                    ingress:
                      class: traefik