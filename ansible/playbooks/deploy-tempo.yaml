- name: Deploy Tempo with MinIO
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'HELM_CHARTS_PATH') != ''
          - lookup('env', 'TEMPO_MINIO_ACCESS_KEY') != ''
          - lookup('env', 'TEMPO_MINIO_SECRET_KEY') != ''
        fail_msg: "KUBECONFIG, HELM_CHARTS_PATH, TEMPO_MINIO_ACCESS_KEY, and TEMPO_MINIO_SECRET_KEY environment variables must be set"

  tasks:
    - name: Create Tempo namespace
      kubernetes.core.k8s:
        kind: Namespace
        name: tempo
        state: present
        
    - name: Create Tempo MinIO Credentials Secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: tempo-minio-creds
            namespace: tempo
          stringData:
            rootUser: "{{ lookup('env', 'TEMPO_MINIO_ROOT_USER') }}"
            rootPassword: "{{ lookup('env', 'TEMPO_MINIO_ROOT_PASSWORD') }}"
      no_log: true
      
    - name: Deploy Tempo
      kubernetes.core.helm:
        name: tempo
        chart_ref: oci://ghcr.io/grafana/helm-charts/tempo-distributed
        chart_version: 1.60.0
        release_namespace: tempo
        wait: true
        timeout: 5m
        values_files:
          - "{{ lookup('env', 'HELM_CHARTS_PATH') }}/tempo/values.yaml"

