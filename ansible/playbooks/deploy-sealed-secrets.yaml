- name: Deploy Sealed Secrets Controller
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
        fail_msg: "KUBECONFIG environment variable must be set"

  tasks:
    - name: Install Sealed Secrets Controller from GitHub
      ansible.builtin.command: >
        kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.26.0/controller.yaml
      register: sealed_secrets_apply_result
      retries: 3
      delay: 5
      until: sealed_secrets_apply_result.rc == 0
      failed_when: false
      changed_when: sealed_secrets_apply_result.rc == 0

    - name: Wait for Sealed Secrets Controller deployment
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: kube-system
        name: sealed-secrets-controller
      register: sealed_secrets_deployment
      until: sealed_secrets_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10
