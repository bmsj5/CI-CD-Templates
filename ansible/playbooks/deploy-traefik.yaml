- name: Deploy Traefik Ingress Controller
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'HELM_CHARTS_PATH') != ''
        fail_msg: "KUBECONFIG and HELM_CHARTS_PATH environment variables must be set"

  tasks:
    - name: Install Traefik Ingress Controller
      kubernetes.core.helm:
        name: traefik
        chart_ref: traefik
        chart_repo_url: https://helm.traefik.io/traefik
        chart_version: 39.0.0
        release_namespace: kube-system
        wait: true
        timeout: 5m
        values_files:
          - "{{ lookup('env', 'HELM_CHARTS_PATH') }}/traefik/values.yaml"
