---
- name: Deploy Vector to K3s Cluster
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'ZO_ROOT_USER_EMAIL') != ''
          - lookup('env', 'ZO_ROOT_USER_PASSWORD') != ''
        fail_msg: "KUBECONFIG, ZO_ROOT_USER_EMAIL, and ZO_ROOT_USER_PASSWORD environment variables must be set"

  tasks:
    - name: Create the 'vector' namespace
      kubernetes.core.k8s:
        kind: Namespace
        name: vector
        state: present

    - name: Create the OpenObserve credentials secret for Vector
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: openobserve-creds
            namespace: vector
          stringData:
            username: "{{ lookup('env', 'ZO_ROOT_USER_EMAIL') }}"
            password: "{{ lookup('env', 'ZO_ROOT_USER_PASSWORD') }}"
      no_log: true

    - name: Deploy Vector
      kubernetes.core.helm:
        name: vector
        chart_ref: oci://ghcr.io/vectordotdev/helm-charts/vector
        chart_version: 0.49.0
        release_namespace: vector
        create_namespace: true
        wait: true
        timeout: 5m
        values_files:
          - "/workspace/helm-charts/vector/values.yml"