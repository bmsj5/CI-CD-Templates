# Dedicated collector for Kubernetes API server metrics
# Deployment with 1 replica = exactly 1 collector scraping exactly 1 endpoint

mode: deployment
replicaCount: 1

image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    cpu: 100m
    memory: 256Mi
  requests:
    cpu: 50ms
    memory: 192Mi

presets:
  kubernetesAttributes:
    enabled: true

clusterRole:
  create: true
  rules:
    # Permission to scrape API server metrics endpoint
    - nonResourceURLs: [/metrics]
      verbs: [get]
    # Permissions for Kubernetes service discovery (endpointslice role)
    # Required for kubernetes_sd_configs to discover API server endpoints
    - apiGroups: [discovery.k8s.io]
      resources: [endpointslices]
      verbs: [get, list, watch]
    - apiGroups: [""]
      resources: [services]
      verbs: [get, list, watch]

service:
  enabled: false

extraEnvs:
  - name: PROJECT
    valueFrom:
      configMapKeyRef:
        name: cluster-labels
        key: project
  - name: APP
    valueFrom:
      configMapKeyRef:
        name: cluster-labels
        key: app
  - name: REGION
    valueFrom:
      configMapKeyRef:
        name: cluster-labels
        key: region
  - name: CLUSTER_ID
    valueFrom:
      configMapKeyRef:
        name: cluster-labels
        key: cluster_id
  - name: ENV
    valueFrom:
      configMapKeyRef:
        name: cluster-labels
        key: env

config:
  receivers:
    prometheus:
      config:
        scrape_configs:
          - job_name: kubernetes-apiserver
            scrape_interval: 15s
            metrics_path: /metrics
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token 
            kubernetes_sd_configs:
              - role: endpointslice
            relabel_configs:
              # Filter: Target the default/kubernetes service (The API Server)
              - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpointslice_port_name]
                action: keep
                regex: default;kubernetes;https

            metric_relabel_configs:
              # Keep only essential API server metrics used in Grafana dashboard
              - source_labels: [__name__]
                regex: (apiserver_(requested_deprecated_apis|request_total|request_duration_seconds_(sum|count))|workqueue_depth|process_(cpu_seconds_total|resident_memory_bytes)|up)
                action: keep

  processors:
    # Add external labels as resource attributes
    resource:
      attributes:
        - key: project
          value: ${PROJECT}
          action: upsert
        - key: app
          value: ${APP}
          action: upsert
        - key: region
          value: ${REGION}
          action: upsert
        - key: cluster.id
          value: ${CLUSTER_ID}
          action: upsert
        - key: env
          value: ${ENV}
          action: upsert
    # Convert these attributes to strings
    transform:
      error_mode: ignore
      metric_statements:
        - context: resource
          statements:
            - set(attributes["cluster.id"], Concat([attributes["cluster.id"]], ""))
    k8sattributes:
      auth_type: serviceAccount
      extract:
        metadata:
          - k8s.pod.name
          - k8s.namespace.name
          - k8s.node.name
    batch:
      timeout: 5s

  exporters:
    prometheusremotewrite:
      endpoint: http://vm-vminsert.victoria-metrics.svc.cluster.local:8480/insert/0/prometheus
      tls:
        insecure: true
      resource_to_telemetry_conversion:
        enabled: true
      remote_write_queue:
        queue_size: 20
      retry_on_failure:
        max_elapsed_time: 2m
        
  service:
    pipelines:
      metrics:
        receivers: [prometheus]
        processors: [resource, transform, k8sattributes, batch]
        exporters: [prometheusremotewrite]
