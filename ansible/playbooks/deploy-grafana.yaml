- name: Deploy Grafana with PostgreSQL
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Ensure required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'KUBECONFIG') != ''
          - lookup('env', 'HELM_CHARTS_PATH') != ''
          - lookup('env', 'GRAFANA_DB_PASSWORD') != ''
          - lookup('env', 'ZO_ROOT_USER_EMAIL') != ''
          - lookup('env', 'ZO_ROOT_USER_PASSWORD') != ''
          - lookup('env', 'GRAFANA_ADMIN_PASSWORD') != ''
        fail_msg: "KUBECONFIG, HELM_CHARTS_PATH, GRAFANA_DB_PASSWORD, ZO_ROOT_USER_EMAIL, ZO_ROOT_USER_PASSWORD, and GRAFANA_ADMIN_PASSWORD environment variables must be set"

  tasks:
    - name: Create the 'grafana' namespace
      kubernetes.core.k8s:
        kind: Namespace
        name: grafana
        state: present

    - name: Check if Grafana database password secret exists
      kubernetes.core.k8s_info:
        kind: Secret
        name: grafana-db-pass-secret
        namespace: grafana
      register: grafana_db_secret_check
      ignore_errors: true

    - name: Create Grafana database credentials secret
      kubernetes.core.k8s:
        apply: true
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: grafana-db-pass-secret
            namespace: grafana
          type: Opaque
          stringData:
            username: grafana
            password: "{{ lookup('env', 'GRAFANA_DB_PASSWORD') }}"
      no_log: true

    - name: Create PostgreSQL cluster for Grafana
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', lookup('env', 'HELM_CHARTS_PATH') + '/grafana/postgres-cluster.yaml') | from_yaml }}"

    - name: Wait for Grafana PostgreSQL cluster to be ready
      kubernetes.core.k8s_info:
        kind: Cluster
        namespace: grafana
        name: grafana-postgres
      register: grafana_postgres_cluster
      until: grafana_postgres_cluster.resources[0].status.readyInstances | default(0) >= 3
      retries: 30
      delay: 10

    - name: Create Grafana datasources ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-datasources
            namespace: grafana
          data:
            datasources.yaml: "{{ lookup('template', lookup('env', 'HELM_CHARTS_PATH') + '/grafana/datasources.yaml') }}"
      vars:
        openobserve_user: "{{ lookup('env', 'ZO_ROOT_USER_EMAIL') }}"
        openobserve_password: "{{ lookup('env', 'ZO_ROOT_USER_PASSWORD') }}"
      no_log: true

    - name: Deploy Grafana
      kubernetes.core.helm:
        name: grafana
        chart_ref: oci://ghcr.io/grafana/helm-charts/grafana
        chart_version: 10.4.3
        release_namespace: grafana
        create_namespace: true
        wait: true
        timeout: 10m
        values_files:
          - "{{ lookup('env', 'HELM_CHARTS_PATH') }}/grafana/values.yaml"
        set_values:
          - value: "env.GF_DATABASE_PASSWORD={{ lookup('env', 'GRAFANA_DB_PASSWORD') }}"
            value_type: string
          - value: "env.GF_SECURITY_ADMIN_USER={{ lookup('env', 'GRAFANA_ADMIN_USER') | default('admin') }}"
            value_type: string
          - value: "env.GF_SECURITY_ADMIN_PASSWORD={{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') }}"
            value_type: string
          - value: adminUser={{ lookup('env', 'GRAFANA_ADMIN_USER') | default('admin') }}
            value_type: string
          - value: adminPassword={{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') }}
            value_type: string

