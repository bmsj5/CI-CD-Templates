# Grafana Tempo Configuration - Distributed/Microservices Mode
# Required secrets: see required-secrets.yaml in this directory.
#
# -----------------------------------------------------------------------------
# 1. APPLICATION CONFIGURATION
# -----------------------------------------------------------------------------

tempo:
  # Structured Config (The App Logic)
  structuredConfig:
    server:
      http_listen_port: 3200
      grpc_listen_port: 9095

    # Distributor: Forward to Ingesters. 
    distributor:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317

    # Ingester: Sets the Replication Factor for the whole cluster.
    ingester:
      max_block_bytes: 134217728
      lifecycler:
        ring:
          replication_factor: 1

    # Storage: S3 (same secret as MinIO subchart: rootUser/rootPassword)
    storage:
      trace:
        backend: s3
        s3:
          endpoint: tempo-minio.tempo.svc.cluster.local:9000
          bucket: tempo-traces
          access_key: ${rootUser}
          secret_key: ${rootPassword}
          insecure: true

    compactor:
      compaction:
        block_retention: 720h
        compacted_block_retention: 1h

    querier:
      frontend_worker:
        frontend_address: tempo-query-frontend-discovery.tempo.svc.cluster.local:9095

# -----------------------------------------------------------------------------
# 2. INFRASTRUCTURE CONFIGURATION
# -----------------------------------------------------------------------------

traces:
  otlp:
    grpc:
      enabled: true

# We inject the secret into every component so they can access S3

distributor:
  replicas: 1
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: tempo-minio-creds
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

ingester:
  replicas: 1
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: tempo-minio-creds
  persistence:
    enabled: true
    size: 1Gi
    storageClass: local-path
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi 

querier:
  replicas: 1
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: tempo-minio-creds
  resources:
    limits:
      cpu: 200m
      memory: 512Mi
    requests:
      cpu: 50m
      memory: 256Mi

compactor:
  replicas: 1
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: tempo-minio-creds
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

queryFrontend:
  replicas: 1
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: tempo-minio-creds
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

memcached:
  replicas: 1

minio:
  enabled: true
  replicas: 1
  existingSecret: tempo-minio-creds
  persistence:
    enabled: true
    size: 20Gi
    storageClass: local-path
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi
  buckets:
    - name: tempo-traces